name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# GitHub Pages „Éá„Éó„É≠„Ç§Áî®„ÅÆÊ®©ÈôêË®≠ÂÆö
permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test:
    name: Build & Test (matrix)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        feature-set: [default, strict]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache
        uses: Swatinem/rust-cache@v2
      - name: Build
        run: |
          if [ "${{ matrix.feature-set }}" = "strict" ]; then
            # Deny deprecated symbols globally
            export RUSTFLAGS="-D deprecated"
            cargo build --workspace --all-targets
          else
            cargo build --workspace --all-targets
          fi
      - name: Clippy (deny warnings)
        run: |
          if [ "${{ matrix.feature-set }}" = "strict" ]; then
            export RUSTFLAGS="-D deprecated"
          fi
          cargo clippy --workspace --all-targets -- -D warnings
      - name: Test
        run: |
          if [ "${{ matrix.feature-set }}" = "strict" ]; then
            export RUSTFLAGS="-D deprecated"
            cargo test --workspace
          else
            cargo test --workspace
          fi
      - name: Format check
        if: matrix.feature-set == 'default' || matrix.feature-set == 'strict'
        run: cargo fmt -- --check

  foundation-architecture-scan:
    name: Foundation Architecture Compliance Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check Core/Extension Foundation Pattern Compliance
        run: |
          set -e
          echo "Checking Core/Extension Foundation pattern compliance..."

          # 1. Á¶ÅÊ≠¢: geo_primitives Â§ñ„Åã„Çâ„ÅÆÁõ¥Êé•„Éó„É™„Éü„ÉÜ„Ç£„Éñ„Ç§„É≥„Éù„Éº„Éà
          echo "Checking for forbidden direct primitive imports..."
          ! grep -R "use geo_primitives::" -n --exclude-dir target --exclude-dir geo_primitives --exclude-dir .github . || (echo "Forbidden direct geo_primitives import outside geo_primitives crate" && exit 1)

          # 2. Á¶ÅÊ≠¢: Core Foundation „ÇíÁµåÁî±„Åó„Å™„ÅÑ‰Ωé„É¨„Éô„É´„Ç¢„ÇØ„Çª„Çπ
          echo "Checking for deprecated low-level geometry access..."
          ! grep -R "use geo_core::" -n --exclude-dir target --exclude-dir geo_core --exclude-dir .github . || (echo "Deprecated geo_core direct import - use geo_foundation instead" && exit 1)

          # 3. Êé®Â•®: geo_foundation ÁµåÁî±„ÅÆ„Ç¢„ÇØ„Çª„Çπ„Éë„Çø„Éº„É≥
          echo "Checking foundation-based access patterns..."
          # geo_foundation „Åã„Çâ„ÅÆ„Ç§„É≥„Éù„Éº„Éà„ÅØË®±ÂèØÔºàÊé®Â•®„Éë„Çø„Éº„É≥Ôºâ
          grep -R "use geo_foundation::" -n --exclude-dir target --exclude-dir .github . > foundation_imports.txt || true
          if [ -s foundation_imports.txt ]; then
            echo "‚úÖ Found proper foundation-based imports:"
            head -5 foundation_imports.txt
          fi

          # 4. Á¶ÅÊ≠¢: Êóß geometry „É¢„Ç∏„É•„Éº„É´„ÅÆ‰ΩøÁî®
          echo "Checking for deprecated geometry module usage..."
          ! grep -R "use.*geometry::" -n --exclude-dir target --exclude-dir .github --exclude "*.md" . | grep -v "geo_foundation\|geo_primitives" || (echo "Deprecated geometry module usage - migrate to geo_foundation/geo_primitives" && exit 1)

          echo "‚úÖ Foundation architecture compliance check passed!"

  build-docs:
    name: Build Documentation (verify only)
    runs-on: ubuntu-latest
    # Build docs on all branches except main (main will deploy them)
    if: github.ref != 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup mdBook
        uses: peaceiris/actions-mdbook@v1
        with:
          mdbook-version: 'latest'

      - name: Build documentation (verify only)
        run: |
          mdbook build
          echo "‚úÖ Documentation built successfully (verification only, no deployment)"

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    # Only deploy on pushes to main branch (not PRs or other branches)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    # Wait for build-test job to complete successfully
    needs: [build-test, foundation-architecture-scan]

    # GitHub Pages „Éá„Éó„É≠„Ç§Áí∞Â¢ÉË®≠ÂÆö
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup mdBook
        uses: peaceiris/actions-mdbook@v1
        with:
          mdbook-version: 'latest'

      - name: Build documentation
        run: mdbook build

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  check-deployment-skipped:
    name: Check Deployment Status
    runs-on: ubuntu-latest
    # Show status for branches that don't deploy
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    needs: [build-test, foundation-architecture-scan]
    steps:
      - name: Deployment skipped notification
        run: |
          echo "‚ÑπÔ∏è  GitHub Pages deployment skipped for branch: ${{ github.ref_name }}"
          echo "üìñ Documentation deployment only occurs on the 'main' branch"
          echo "‚úÖ Branch build and test completed successfully"
